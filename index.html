<script>
    // âœ… ä¿®å¤æ ¸å¿ƒï¼šæ¢æˆå›½é™…æœ€ç¨³çš„ jsdelivr æºï¼Œ
    // è¿™ä¸ªæºé‡Œè‚¯å®šæœ‰ manifest.jsonï¼Œä¸ä¼šæŠ¥é”™ "metadata not found"
    const DATA_URL = "https://cdn.jsdelivr.net/npm/@imgly/background-removal-data@1.7.0/dist/";

    let isReady = false;

    // 1. ä¹Ÿæ˜¯è½®è¯¢æ£€æµ‹ï¼Œç¡®ä¿ imgly.js åŠ è½½å®Œ
    function checkEngine() {
        if (window.imglyRemoveBackground) {
            isReady = true;
            document.getElementById('statusBadge').innerText = "âœ… å¼•æ“å°±ç»ª (Ready)";
            document.getElementById('statusBadge').style.background = "#4ade80";
            document.getElementById('statusBadge').style.color = "#000";
        } else {
            setTimeout(checkEngine, 500);
        }
    }
    checkEngine();

    // 2. æ‹–æ‹½é€»è¾‘
    const dropArea = document.getElementById('dropArea');
    dropArea.addEventListener('dragover', e => { e.preventDefault(); });
    dropArea.addEventListener('drop', e => { e.preventDefault(); if(e.dataTransfer.files[0]) start(e.dataTransfer.files[0]); });

    // 3. å¼€å§‹è¿è¡Œ
    async function start(file) {
        if (!isReady) { alert("å¼•æ“åˆå§‹åŒ–ä¸­ï¼Œè¯·ç¨ç­‰..."); return; }
        
        document.getElementById('statusBadge').innerText = "ğŸš€ æ­£åœ¨ä¸‹è½½ AI æ¨¡å‹...";
        document.getElementById('statusBadge').style.background = "#fbbf24";
        
        try {
            const blob = await window.imglyRemoveBackground(file, {
                publicPath: DATA_URL, // ğŸ‘ˆ è¿™é‡Œæ˜¯å…³é”®ï¼Œå¿…é¡»ç”¨ä¸Šé¢å®šä¹‰çš„é‚£ä¸ªæ–°åœ°å€
                progress: (key, cur, total) => {
                    const pct = Math.round((cur/total)*100);
                    // ä¼˜åŒ–äº†ä¸€ä¸‹æç¤ºæ–‡æ¡ˆ
                    if (key.includes('fetch')) {
                        document.getElementById('statusBadge').innerText = `â¬‡ï¸ ä¸‹è½½æ¨¡å‹èµ„æº: ${pct}%`;
                    } else {
                        document.getElementById('statusBadge').innerText = `ğŸ§  æ­£åœ¨æŠ å›¾ä¸­: ${pct}%`;
                    }
                }
            });
            
            const url = URL.createObjectURL(blob);
            document.getElementById('resImg').src = url;
            window.dlUrl = url;
            
            document.getElementById('dropArea').style.display = 'none';
            document.getElementById('resultArea').style.display = 'block';
            
        } catch (e) {
            console.error(e);
            document.getElementById('statusBadge').innerText = "âŒ å¤±è´¥: " + e.message;
            alert("èµ„æºåŠ è½½å¤±è´¥ï¼\nè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚\né”™è¯¯è¯¦æƒ…ï¼š" + e.message);
        }
    }

    function dl() {
        const a = document.createElement('a');
        a.href = window.dlUrl; a.download = 'æŠ å›¾ç»“æœ.png'; a.click();
    }
</script>
