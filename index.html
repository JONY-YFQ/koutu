<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIæŠ å›¾ï¼ˆ1.5.1 ç¨³å®šç‰ˆï¼‰</title>
    <style>
        /* --- æ ·å¼ä¿æŒä¸å˜ --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: radial-gradient(circle at center, #1e3a5f 0%, #0f172a 70%, #020617 100%);
            color: #fff; margin: 0; padding: 40px 20px;
            min-height: 100vh; display: flex; flex-direction: column; align-items: center;
        }
        .main-container { width: 100%; max-width: 900px; display: flex; flex-direction: column; align-items: center; }
        .circle-drop-zone {
            position: relative; width: 480px; height: 480px;
            display: flex; justify-content: center; align-items: center; cursor: pointer;
            border-radius: 50%; margin: 50px;
            background: rgba(30, 58, 95, 0.3);
            box-shadow: 0 0 0 25px rgba(31, 78, 121, 0.4);
            transition: 0.3s;
        }
        .circle-drop-zone:hover { transform: scale(1.02); box-shadow: 0 0 30px rgba(0, 212, 255, 0.3); }
        .icon-folder { font-size: 80px; margin-bottom: 20px; color: #00d4ff; }
        h3 { font-size: 28px; margin: 0 0 10px 0; }
        .sub-text { color: #94a3b8; font-size: 16px; }
        .status-badge {
            margin-top: 20px; padding: 8px 16px; border-radius: 20px; font-size: 14px;
            background: #334155; color: #fbbf24; transition: 0.3s;
        }
        .result-area { display: none; margin-top: 40px; text-align: center; }
        img { max-width: 100%; border-radius: 12px; border: 1px solid #475569; }
        .btn { background: #00d4ff; color: #000; font-weight: bold; padding: 15px 40px; border-radius: 30px; border: none; font-size: 18px; margin-top: 20px; cursor: pointer; }
        /* å¢åŠ ä¸€ä¸ªé”™è¯¯æ—¥å¿—æ˜¾ç¤ºåŒºï¼Œæ–¹ä¾¿æ’æŸ¥ */
        #debugLog { font-size: 12px; color: #64748b; margin-top: 20px; max-width: 80%; text-align: center; display:none;}
    </style>
</head>
<body>

<div class="main-container">
    <h1 style="margin-bottom: 40px;">ğŸš€ AI æŠ å›¾ (1.5.1 ç¨³å®šç‰ˆ)</h1>

    <div class="circle-drop-zone" id="dropArea" onclick="document.getElementById('fileInput').click()">
        <div style="z-index: 2; text-align: center;">
            <div class="icon-folder">ğŸ“</div>
            <h3>ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ </h3>
            <div class="status-badge" id="statusBadge">â³ ç³»ç»Ÿåˆå§‹åŒ–ä¸­...</div>
        </div>
        <input type="file" id="fileInput" accept="image/*" style="display:none" onchange="start(this.files[0])">
    </div>

    <div id="debugLog"></div>

    <div class="result-area" id="resultArea">
        <h3>ğŸ‰ å¤„ç†ç»“æœ</h3>
        <img id="resImg">
        <br>
        <button class="btn" onclick="dl()">ä¸‹è½½å›¾ç‰‡</button>
    </div>
</div>

<script type="module">
    // âœ… æ ¸å¿ƒä¿®æ”¹1ï¼šé™çº§åˆ° 1.5.1 ç‰ˆæœ¬
    // ç¤¾åŒºåé¦ˆè¿™ä¸ªç‰ˆæœ¬æœ€ç¨³å®šï¼Œèƒ½æœ‰æ•ˆé¿å… "metadata not found" é”™è¯¯
    import { removeBackground } from "https://cdn.jsdelivr.net/npm/@imgly/background-removal@1.5.1/+esm";
    window.imglyRemoveBackground = removeBackground;
    console.log("Engine 1.5.1 Loaded!");
</script>

<script>
    // âœ… æ ¸å¿ƒä¿®æ”¹2ï¼šæ•°æ®æºä¹Ÿä¸¥æ ¼é”å®š 1.5.1ï¼Œå¹¶ä½¿ç”¨ã€é¥¿äº†ä¹ˆã€‘å›½å†…æº
    // è¿™ä¸ªæºåœ¨å›½å†…é€Ÿåº¦æœ€å¿«ï¼Œä¸” 1.5.1 ç‰ˆæœ¬çš„æ–‡ä»¶ç»“æ„éå¸¸æ ‡å‡†ï¼Œä¸å®¹æ˜“å‡ºé”™
    const DATA_URL = "https://npm.elemecdn.com/@imgly/background-removal-data@1.5.1/dist/";

    let isReady = false;

    function checkEngine() {
        if (window.imglyRemoveBackground) {
            isReady = true;
            document.getElementById('statusBadge').innerText = "âœ… å¼•æ“å°±ç»ª (Ready)";
            document.getElementById('statusBadge').style.background = "#4ade80";
            document.getElementById('statusBadge').style.color = "#000";
        } else {
            setTimeout(checkEngine, 500);
        }
    }
    checkEngine();

    const dropArea = document.getElementById('dropArea');
    dropArea.addEventListener('dragover', e => { e.preventDefault(); });
    dropArea.addEventListener('drop', e => { e.preventDefault(); if(e.dataTransfer.files[0]) start(e.dataTransfer.files[0]); });

    async function start(file) {
        if (!isReady) { alert("å¼•æ“åŠ è½½ä¸­ï¼Œè¯·ç¨å..."); return; }
        
        document.getElementById('statusBadge').innerText = "ğŸš€ æ­£åœ¨è¿æ¥å›½å†…èŠ‚ç‚¹...";
        document.getElementById('statusBadge').style.background = "#fbbf24";
        document.getElementById('debugLog').style.display = 'none';
        
        try {
            const blob = await window.imglyRemoveBackground(file, {
                publicPath: DATA_URL, 
                // debug: true, // å¼€å¯è°ƒè¯•æ¨¡å¼
                progress: (key, cur, total) => {
                    // åªè¦èƒ½è¿›åˆ°è¿™é‡Œï¼Œè¯´æ˜å·²ç»è¿ä¸Šèµ„æºäº†
                    const pct = Math.round((cur/total)*100);
                    if (key.includes('fetch')) {
                        document.getElementById('statusBadge').innerText = `â¬‡ï¸ ä¸‹è½½æ¨¡å‹èµ„æº: ${pct}%`;
                    } else {
                        document.getElementById('statusBadge').innerText = `ğŸ§  æ­£åœ¨è®¡ç®—: ${pct}%`;
                    }
                }
            });
            
            const url = URL.createObjectURL(blob);
            document.getElementById('resImg').src = url;
            window.dlUrl = url;
            
            document.getElementById('dropArea').style.display = 'none';
            document.getElementById('resultArea').style.display = 'block';
            
        } catch (e) {
            console.error(e);
            document.getElementById('statusBadge').innerText = "âŒ è¿æ¥ä¸­æ–­";
            
            // æ˜¾ç¤ºå…·ä½“çš„é”™è¯¯é“¾æ¥ï¼Œæ–¹ä¾¿ä½ ï¼ˆæˆ–æˆ‘ï¼‰æ’æŸ¥
            const debugLog = document.getElementById('debugLog');
            debugLog.style.display = 'block';
            debugLog.innerHTML = `é”™è¯¯è¯¦æƒ…: ${e.message}<br>å°è¯•è®¿é—®çš„æ•°æ®æº: ${DATA_URL}`;

            alert("ğŸ˜” å¤„ç†å¤±è´¥ï¼\n\nåŸå› ï¼šç½‘ç»œè¿æ¥è¢«é‡ç½®æˆ–è¶…æ—¶ (Failed to fetch)ã€‚\nå»ºè®®ï¼š\n1. è¯·å°è¯•åˆ·æ–°é¡µé¢å†è¯•ä¸€æ¬¡ï¼ˆæœ‰æ—¶æ˜¯å¶å‘æ³¢åŠ¨ï¼‰ã€‚\n2. å¦‚æœè¿˜ä¸è¡Œï¼Œè¯´æ˜æ‚¨å½“å‰çš„ç½‘ç»œç¯å¢ƒå®Œå…¨å±è”½äº†è¯¥ AI æ¨¡å‹åº“çš„ä¸‹è½½ã€‚");
        }
    }

    function dl() {
        const a = document.createElement('a');
        a.href = window.dlUrl; a.download = 'æŠ å›¾ç»“æœ.png'; a.click();
    }
</script>
</body>
</html>
